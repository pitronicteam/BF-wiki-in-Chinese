# Betaflight 4.2

### **Betaflight 4.2 带来了…**

* **更准确的循环时间** - 改善了RPM滤波器性能
* **改进了的前馈** - 使飞行更加顺畅，下文附有摘要，用以优化平滑设置，以达到电影式飞行的目的
* **新的动态Dterm滤波截止频率曲线** - 通过提高Dterm滤波器截止频率的移动速度来加强过冲抑制能力
* **电池压降动态补偿 **- 为飞行提供一致的油门响应和PID“感觉”
* **新的Rate模式** - 更直观地调节那些重要参数，并为竞速和电影飞行用途提供更线性的“操控感”
* **改进的动态陷波滤波器 **- 更好的噪声抑制能力，简化的最大/最小截止频率配置
* **自动抗自旋配置 **- 更快地抑止偏航自旋
* **独立于I值的反重力增益 **- 若更改I，反重力的效果强度不会随之改变
* **更简单、更好用的RC平滑** - 仔细优化过的默认配置意味着几乎不再需要手动设置平滑参数
* **I值释放可在设定点模式下正常工作 **- 修复了4.0和4.1中的一个错误。该错误导致在设定点模式下降低溢出值的作用很小。现在设定点模式可正常运行，由此错误而被迫使用陀螺仪模式的用户，应返回到设定点模式。
* **NFE竞速模式** - 一种非常有趣的飞行模式，Pitch手动，Roll自稳。
* **配置程序10.7 **- 进行了许多改进，尤其是可以正确显示不同Rate模式下对应的实际曲线
* **OSD改进 **- 现在每次解锁时都可短暂显示启动徽标；CRSF会同时显示当前模式和信号强度；添加了相机取景框，距离返航点距离，电池效率等新元素。

\
**对于绝大多数飞机来说，4.2的默认值可以提供相当优秀的飞行体验，无需进行修改。**如果您非常清楚您的飞机确实需要使用特殊的PID，请务必重新调参，因为4.2中的新功能，会使得同样的PID产生不同的结果。例如，如果您希望D值非常高而不受噪声强度限制，旧版本中不行，现在却可以。\
\
**某些弱动力飞机（弱动力小无刷、涵道式摄像飞机、7寸及更大的飞机、长续航飞机等）可能需要一些特殊设置以减小回弹。**\
如果您不熟悉4.2，请先阅读[《4.1调参指南》](betaflight-4.1.md)和[《4.0调参指南》](betaflight-4.0.md)。\
**请使用最新版本的Betaflight配置程序，早期版本将无法与4.2搭配使用。**

**注意1：**请勿将任何先前版本的diff或dump输出直接粘贴到4.2的CLI中。

**注意2：**如果您在先前版本将dyn\_notch\_range设置为LOW或HIGH，请将dyn\_notch\_max\_hz动态陷波滤波最大频率设置为350或700.

**注意3：**如果您以前的PID的I值一直保持默认值，那么在刷写4.2之后您需要对反重力增益稍作修改才能获得相同的效果。

**注意4：**请先从默认滤波和PID开始调整，除非您十分确信您的飞机需要进行特殊设置。

**注意5：**我们建议启用RPM滤波器。[点击这里](http://mp.weixin.qq.com/s?\_\_biz=Mzg4OTAzNzM5MA==\&mid=2247484384\&idx=1\&sn=0b0debb82c7e3b6ad0de227a830ad7b9\&chksm=cff0b4c1f8873dd72e267f22644bc23fa7a388f19b277dce35acc8cf17461c4b76feb3c3853c\&scene=21#wechat\_redirect)阅读有关启用和配置PRM滤波器的详细信息。

### **快速设置**

\
下列是一些参考性的配置片段，包含了一些并不是很常见的设置，以适应不同的飞行风格。对于普通的花飞和竞速来说，默认值应该比较合适。我们无法保证它将完美适配您的飞机，而且他们不包括PID参数或滤波设置，但它可以为其中某些数字提供一定的参数范围参考。

**专业竞速**(激进式前馈，需要有非常干净的RC信号，否则将可能因为RC质量不良引起的RC数据帧抖动而导致电机过热)

```
set iterm_relax_cutoff = 30
set rc_smoothing_auto_smoothness = 5
set ff_interpolate_sp = ON
set ff_smooth_factor = 0
set ff_spike_limit = 60set ff_boost = 20set feedforward_transition = 0
set yaw_lowpass_hz = 100
set throttle_boost = 7
set throttle_boost_cutoff = 25
set dyn_lpf_dterm_curve_expo = 7
set gyro_rpm_notch_q = 600
```

（启用电池电压补偿，只要适用于您的飞机，那么值越高越好，D expo也是如此）

**普通花飞/竞速**(强前馈，可应对常见的RC信号丢帧情况，反应灵敏)

```
set iterm_relax_cutoff = 20
set rc_smoothing_auto_smoothness = 7
set ff_interpolate_sp = AVERAGED_2
set ff_smooth_factor = 20
set ff_spike_limit = 70
set ff_boost = 15
set feedforward_transition = 0
set yaw_lowpass_hz = 100
set throttle_boost = 7
set throttle_boost_cutoff = 25
set dyn_lpf_dterm_curve_expo = 7
set gyro_rpm_notch_q = 700
```

**HD**(用于拍摄高清视频的平滑前馈，低速转弯十分平稳，较低的I值释放阈值以最小化回弹)

```
set iterm_relax_cutoff = 10
set rc_smoothing_auto_smoothness = 20
set ff_interpolate_sp = AVERAGED_3
set ff_smooth_factor = 40
set ff_spike_limit = 55
set ff_boost = 0
set feedforward_transition = 40
set yaw_lowpass_hz = 70
set throttle_boost = 5
set throttle_boost_cutoff = 10
set dyn_lpf_dterm_curve_expo = 7
set gyro_rpm_notch_q = 800
```

**电影式飞行**(仅限低速转弯，否则飞起来会觉得很“肉”)

```
set iterm_relax_cutoff = 5
set rc_smoothing_auto_smoothness = 40
set ff_interpolate_sp = AVERAGED_4
set ff_smooth_factor = 50
set ff_spike_limit = 50
set ff_boost = 0
set feedforward_transition = 70
set yaw_lowpass_hz = 50
set throttle_boost = 2
set throttle_boost_cutoff = 10
set dyn_lpf_dterm_curve_expo = 8
set gyro_rpm_notch_q = 900
set iterm_windup = 75
```

下面的调参建议可能有助于最大程度地减小高清视频中的轻微随机抖动：

* 禁用D\_Min
* 使用PD比滑块**，**将D设置得比P高约20%
* 将TPA设置为仅衰减D，从您的巡航油门值起始，并稍微增加衰减百分比
* 将Dterm低通滤波expo设置的尽可能高（您会受到中油门附近的D噪声限制）（当D更高，您可能需要更多的Dterm滤波，例如将Dterm滤波滑块向左移动两个格子）
* P值比普通的花式飞行P值低20%，使得P仅仅能够提供基本的稳定性
* I值降低一半
* 提高FF过滤强度
* 将Rate类型设为actual，中央灵敏度设置为10，Expo设为0，最大Rate使用您常用的最大Rate。当Expo为0可以为中央杆位提供柔和的感觉，可以使您在摇杆偏离中央时快速反应过来。当中央灵敏度非常低时，可能不需要前馈过渡/死区。

**返回默认值**(值为0意味着“关闭”)

```
set iterm_relax_cutoff = 15
set rc_smoothing_auto_smoothness = 10
set ff_interpolate_sp = AVERAGED_2
set ff_smooth_factor = 37	
set ff_spike_limit = 60
set ff_boost = 15
set feedforward_transition = 0
set yaw_lowpass_hz = 0
set throttle_boost = 5
set throttle_boost_cutoff = 15
set dyn_lpf_dterm_curve_expo = 5
set gyro_rpm_notch_q = 500
set iterm_windup = 100
```

**一次性开启其他所有推荐使用的新功能**

```
set dyn_lpf_dterm_curve_expo = 6
set vbat_sag_compensation = 100
set vbat_pid_gain = OFF
set rc_smoothing_type = FILTER
set rc_smoothing_input_hz = 0
set rc_smoothing_derivative_hz = 0
set rc_smoothing_input_type = BIQUAD
set rc_smoothing_derivative_type = PT1
set rc_smoothing_auto_smoothness = 10
```

开启电池压降动态补偿

```
set vbat_sag_compensation = 100
set vbat_pid_gain = OFF
```

### **最小化回弹的设置**

目前，Betaflight默认值旨在给予中等性能的四轴飞行器最出色的表现，“中等性能”指的是大多数重量较轻，响应性良好的5寸飞机和更小的飞机。

“弱动力”飞机，例如弱动力小无刷、涵道HD摄像飞机、重型4s花飞飞机和许多7寸及更大的飞机，它们所具有的共同点是，相较于“中等性能”的飞机来说，在快速翻滚以及快速进行偏航转弯时，它们往往都会发生回弹。

本段解释了这些飞机会回弹的原因，并将给出解决回弹的方法。

在Betaflight的PID中，I用于提供转弯时的精度、快速平飞时的俯仰精度、大风情况下的稳定性、自由落体和半圈翻滚时的稳定性，控制不对称的空气阻力效应，并在通常情况下清理掉无数无法被P处理掉的持久性残差。随着时间的推移，它会积累一些小的残差的校正值，而该校正值可以使飞机保持正确的姿态。较高的I值将更快、更完整的执行校正值，尤其是在转弯时和大风天，在这种情况下，无法被P、D或FF消除的残差将很小。相对较高的I是Betaflight 4.x在急转弯和长直道上飞行如此精准的原因之一。

如果飞行员打杆速率过快而飞机无法及时响应，则陀螺仪信号将落后于设定点，并且将产生较大的误差信号。这时I将开始积累以修正此问题。I值释放将尝试控制这种积累。若I值被释放得很少，不足以弥补积累速度，则可能会导致Iterm大量积累，并且当飞行员杆位回中时，所有积累下的I都将会将飞机向反方向驱使动作，该动作会逐渐消失，直到角速度归零。这就是飞行员在翻滚结束时看到的那个缓慢的“回弹”动作。

这种动作称为“积分饱和”（Iterm windup）。

我们使用I值释放（iterm\_relax）和I值饱和（iterm\_windup）两个功能来控制与I值有关的回弹。在4.2中这些功能的默认设置对于“中等性能”飞机非常有效。I值释放默认值为15，在正常的翻滚期间会强烈抑制I的积累。I值饱和则适用于偏航问题，并且由于通常情况下根本不需要他，故默认情况下I值饱和关闭。

但是，“弱动力”飞机在快速翻滚及快速掉头后往往会回弹，这是因为从输入信号侧来观察，它们比正常情况具有更高的延迟和更大的误差。在这种情况下，需要为这些机器调整I值释放和I值饱和参数。

当您发现在进行600°/s的翻滚/快速掉头**，**和/或快速打Yaw杆之后出现了烦人的回弹，您就应当意识到您的飞机动力较弱。弱动力飞机的其他表征线索是，您的悬停油门比正常值高（例如您的悬停油门高于25%），或者下落或低油门滑行时产生了缓慢的晃动。

对于偏航来说，任何飞机机臂过长 - 大于6英寸 - 都将导致偏航动力偏弱，并且通常会出现偏航回弹和偏航跳跃问题。

可以通过以下三种方式解决由于I值饱和引起的回弹问题。

**1.最好的方法是调整参数或更改飞机的硬件，以使其响应速度变快。**理想情况下，PID参数匹配的飞机可以在其余功能保持默认的情况下响应得很快。这也将改善飞机的整体处理能力。让我们考虑一下如何做到这一点。

弱动力飞机通常需要较高的P和FF。在某些情况下，可能需要两倍的P和三倍的FF。所有PIDF参数增益都有一个上限，但是您需要尽可能提高。D很可能需要和P同时增大，否则将会导致Pterm震荡，而Dterm噪声则限制了您究竟可以将D增大到多少。您应该向右大幅推动“**摇杆响应增益**”滑块，并且将“**P和D增益**”滑块逐步向右滑动。这将能使机器更快地旋转并减小误差幅值和持续时间，所以它们应当可以减少晃动和回弹。请注意，D过高会延长响应速度，并加重回弹现象。所以在这些机器上使用正确的PD值确实很重要。

假如调整了P和FF，但仍然有晃动和回弹，则应尝试降低I，将其值设为默认值的一半或三分之一。若I过低则将使得飞机在长周期内不稳定，所以也不要将其降得过低。

在硬件方面，弱电机-重桨这样的配置将使得飞机很难快速地改变推力。应该尽量使用较轻较小的螺旋桨，以使得电机更容易旋转。使用与电机动力匹配的螺旋桨可以大大改善因弱动力造成的问题，例如回弹。

在大型飞机上，例如beat-class或xclass，使用螺旋桨内旋（prop-in）布局会提高偏航性能。

任何降低回弹的更改都意味着，您可以令飞机更快速准确地对输入信号做出反应，这是衡量调参成功与否的重要指标。

**2.第二个方法是降低俯仰、横滚或偏航的Rate，或者只是更平稳地飞行**，而使快速翻滚的开始与结束动作稍慢一些。如果不再恶狠狠地压榨硬件的极限，您将会得到良好的整体性能表现，而无需参数优化到极致。

**3.调整我们提供的I值释放（iterm\_relax）和I值饱和（iterm\_windup）功能**

Betaflight使用iterm\_relax来防止快速的翻滚指令产生不必要的I值积累。

其参数iterm\_relax\_cutoff用于设定抑制效果的强度及其持续时间。较低的值会在更长的时间内以更高的强度来抑制I值，这是抑制I值造成的回弹的必要条件。

首先应尝试将iterm\_relax\_cutoff从默认值15降低到10，然后是7，然后是5，注意每次调整后回弹情况都会有所改善。在其“有效工作”的前提下选择尽可能高的值。截止频率越低，转弯就越不准确，因此您需要衡量取舍。您应当选择刚好可以控制回弹现象的最高值。

我们强烈建议使用默认的设定点模式下的I值释放。在4.2中，您无需将其更改为陀螺仪模式，设定点模式下的I值释放可能比4.2中的陀螺仪模式效果更好。

对于偏航存在的回弹问题，首先应当尝试调整偏航PID，优化偏航PID可以改善回弹问题。当您进行偏航动作时，FF会在移动摇杆时提供初始的“推动力”，P会在不久之后提供“推动力”，而I将完成大部分偏航动作。为了获得良好的偏航性能，需要同时使用到这三个元素。

理想情况下，您需要录制日志，用以作为调整P、I和FF的参考依据。应尽量将偏航轴的中等角速率以下的响应延迟，调整至与俯仰和横滚的响应延迟大致相同。

在黑盒日志中您将会看到，对于较高的偏航角速度指令，电机会很快出现较大的输出命令差，其中一对同转向电机油门将达到100%，另一对电机油门为0。这意味着飞机无法执行您所期望的偏航角速度。当发生这种情况时，积分饱和和回弹是不可避免的。

I值饱和（iterm\_windup）解决了偏航轴的这一问题。在旧版本中它作用于所有轴，但在4.2中它专门作用于偏航轴。当电机输出命令差值超过预设的百分比时，它将抑制I值的积累。默认值为100，表示该功能默认关闭。将其设为70可以很好地防止飞机发生偏航回弹。

当电机输出命令差值超过70%时，通过对偏航积分进行抑制，无论我们输入了多长时间的过量指令，都不会发生积分饱和，所以不会发生偏航反弹。最棒的一点是，I值饱和不会削弱对低角速度指令的响应——它们将完全不受影响。

当飞行员输入的设定点的变化率（加速度）相对于飞机来说过高时，acc\_limit和acc\_limit\_yaw会选择性地抑制I值积累。默认情况下，它们是关闭的。它们仅仅会在设定点发生快速变化时才会抑制I，这只是暂时性抑制。由于不良的I值抖动可能会在长周期内反复出现，包括在完全不移动摇杆时也会出现，因此不建议使用这两个参数。

### &#x20;**以上就是你需要知道的全部内容了……去飞吧！**

**下面是为硬核晚间准备的技术细节：**

### **更精准的循环时间**

陀螺仪和PID的调度器已经完全重写，这带来了更少的PID随机抖动和更低的CPU占用率。令它正常工作并不需要进行额外的设置。现在，滤波器更准了，电机温度更低了，续航时间更长了，RPM滤波器的Q因子也可以被设置得更高了。

RC输入信号的处理代码也得到了改进，现在它明显精确了更多，这使得前馈也比以前更顺滑了。

**现在陀螺仪的刷新率被锁在了陀螺仪的“原生”采样率上，无法手动调整。在通常情况下它是8k。**

并且应该重新调整PID更新速率以与飞控的处理器性能相适应。PID循环时间显示在配置程序的底部。对于RPM滤波来说，最重要的就是保证PID循环时间的稳定性。1%的循环时间误差会导致RPM陷波滤波器偏离其正确位置1%。

不开启RPM滤波时，绝大多数F4和F7飞控都可以在8k PID更新速率下完美运行。

开启RPM滤波时，F405和F7xx的飞控应该可以在工作在8k PID速率下，但F405会在4k时更精确。我们建议使用4k，然后试试8k，只有在看起来至少与4k一样稳定时才使用8k。

F411飞控应该设置为4k，通常需要进行超频才能获得最佳效果。

为使随机抖动尽可能少，请关闭黑盒调试功能。只使用1k的速率记录黑盒数据，如无必要，不要使用更高的记录速率或调试功能。

当使用4k或2k PID速率时，下采样过程可能会产生混叠的伪信号。通常可以通过运行在陀螺仪环路中的陀螺仪低通滤波器2来防止其产生。陀螺仪低通滤波器2是唯一一个以陀螺仪频率运行的低通滤波器。当处于4k或更低的PID速率时，如果将其关闭，一个简单的两点平均滤波器会自动代替它。在4k PID速率下，两点平均滤波器可以较好地减少随机晃动，尽管如此，它仍然比不上在1000Hz下运行的陀螺仪低通滤波器2。在2k PID速率时，它无法完全防止混叠。因此**在2k PID速率时，不要关闭陀螺仪低通滤波器2**。

8k PID速率不会出现混叠问题，所以陀螺仪低通滤波器2可以仅为减少噪音而设置或者直接禁用它，而不必担心随机晃动。

在使用4k PID速率时，如果不需要陀螺仪低通滤波器来减少噪声，请将其截止频率设置得尽可能高（直接到1000Hz），或者将其关闭。

使用2k PID速率时，请不要关闭陀螺仪低通滤波器2。

### Dshot设置：

开启RPM滤波时，请在4k PID时候使用Dshot300，或在8k PID时使用Dshot600

当双向DShot/RPM滤波开启时：

* Dshot150 -> 最大2k PID速率
* Dshot300 -> 最大4k PID速率（PID速率为8k时，DShot300会每2次PID循环发送一次数据）
* Dshot600 -> 最大8k PID速率

不开启双向DShot时：

* Dshot150 -> 最大4k PID速率
* Dshot300 -> 最大8k PID速率
* Dshot600 -> 最大16k PID速率（在4.2中，8k是最高PID速率）

### 改善了的前馈

4.2提供了前馈优化，以适合从硬核竞速飞手到电影级摄影飞手的所有人。

当被设置的比较激进时，前馈会迅速对任何摇杆输入作出反应。基本前馈分量摇杆移动度成正比，boost是与摇杆移动的瞬时加速度成正比。在大多数情况下，激进的前馈可以将设定点与陀螺仪之间的响应延迟降到0，从而为竞速飞手提供高质量的控制和即时性。柔和的前馈，包含将前馈过渡阈值调整为30，既可以快速响应较为迅速的摇杆输入，也可以使中央杆位附近的感觉十分平滑，是花式飞行和电影式飞手的理想选择。

激进前馈的主要缺点是在尝试平滑地飞直线时会产生抖动。大多数遥控信号中都存在抖动、丢包或重复的数据，而且我们所有人都会有一些手指/拇指地晃动。如果飞机对微小的速度也会立刻响应地话，那么在尝试平稳地向前飞行或进行平稳的大半径转弯时候，它就会“颤抖”。

竞速飞手和专业级电影摄影飞手的需求相去甚远，所以在开发4.2时，我们投入了大量精力去尽可能适配这些千差万别的需求。

前馈很大程度上取决于RC链路的稳定性以及传入数据包之间步长间隔平滑程度。我们强烈推荐黑羊Crossfire用户升级到最新的CRSF\_Shot固件（包括更新OpenTx系统，为CRSF外部模块提供时钟同步）。Frsky Tx用户应该升级到OpenTx 2.3并关闭ADC功能。

#### 模式： ff\_interpolate\_sp

前馈最重要的参数是它运行的模式，可以用`set ff_interpolate_sp`命令设置：

* `OFF`: 旧的线性插值法，不会进行增压抑或是减少信号毛刺。
* `ON`: 新的基于设定值的插值法，可以立刻响应RC信号的每一次变化，有增压并能减少信号毛刺，适合用于竞速。
* `AVERAGED_2`: 类似“ON”，但会使用两点平均滤波来减少信号毛刺并消除前馈中交替出现上下抖动。在飞直线或进行平滑转弯时会有更少的抖动，适用于包括竞速和花飞在内的大多数情况。（默认设置）
* `AVERAGED_3`: 使用三点平均滤波以减少信号毛刺，可在飞直线或平滑转弯时大大降低抖动。适合带有运动相机的花式飞行。在未升级到CRSF\_Shot时，可有效降低XF接收机在150Hz模式（20ms）下的的抖动。
* `AVERAGED_4`: 使用四点平均滤波以对信号毛刺进行最强的抑制，是电影级高清摄影的好选择。也可以有效的消除R9系统中的抖动。

#### ​平滑度： ff\_smooth\_factor

第二个重要的参数是“平滑度”因子，用于限制RC信号之间的最大变量。它类似于指数型或低通型的平滑函数。CLI参数是`ff_smooth_factor`。默认值为37，最大值为75。

当设为0时，不会前馈信号进行平滑处理。任何输入的RC信号将立刻应用全部FF系数和增压，这可能是拥有干净RC信号链路的竞速飞手所喜爱的。

当保持默认值为37时，RC信号中将有63%被立刻转化为前馈。响应就像一阶低通滤波器，其时间常数为RC信号步长间隔，即截止频率为（1000/2 \* pi \*步长间隔）hz，或者对于6.66ms的RC信号帧长，其截止频率约为24Hz。该参数可消除RC信号中的尖锐毛刺，从而减少了常见的RC链路中的抖动对前馈的影响。

高于默认值的值会提供更平滑的前馈信号，但可能导致大量的延迟，甚至使得前馈变得毫无用处。除了飞行缓慢的电影飞机，不建议在其他任何飞机上这样做。

#### 增压: ff\_boost

该功能相较于4.1没有改变，请参阅[4.1调参指南](https://github.com/betaflight/betaflight/wiki/4.1-Tuning-Notes#Feed-Forward-Limiting)

总体来说，增压对摇杆加速度做出响应，并通过放大迅速打杆动作以降低电机滞后效应。但它会使RC信号抖动产生更多的毛刺伪像。4.2中的默认设置则试图达到良好的平衡。

默认增压值为15，这对几乎适用于所有飞机。竞速飞手可能偏爱20。较高的值可能会在普通飞机上引起微小的过冲、抖动或过度敏感，但在弱动力飞机上最大可以调到30。

#### 峰值限制: ff\_spike\_limit

`ff_spike_limit`用简单的软限幅方式，直接裁切掉前馈信号中的较大尖峰。默认值适用于绝大多数情况。大多数人都应该保持此值为默认值。

更高的数字将会允许更大的前馈尖峰通过。想要完整的激进前馈的竞速飞手或者RC信号干净的飞手可以调高这个值，但是要仔细观察前馈轨线在黑盒日志中的形状来判断具体效果。

一般来说，最大的单次前馈跳跃是当飞手突然从满杆回中时，即在完成一个快速翻滚动作时。如果要尽量减少此时的延迟，则可以尝试将该值调高一些。

#### 过冲限制: ff\_max\_rate\_limit

`ff_max_rate_limit` 相较于4.1也没有改变，请参阅[4.1调参指南](betaflight-4.1.md).

保持它为100就好。

### RC信号平滑改进

经过广泛的测试，默认的RC平滑参数被简化并优化了通常来说，不需要更改默认设置。

默认的自动平滑设置将会根据识别出的RC数据包步长间隔动态计算RC平滑的时间常数。这对于大多数RC遥控系统和前馈插值确实非常有效。默认的输入滤波器类型是`BIQUAD`,用于平滑设定点和P。导数滤波器类型是`PT1`, 可以平滑掉前馈轨线中的尖峰。

大多数飞手都应保持默认设置。

`rc_smoothing_auto_smoothness` 用于设置RC信号的“平滑度”。更高的值会更加平滑，但会增加延迟。10是多数情况下的最佳值。竞速飞手可能更喜欢8，甚至5，但是会有更大的抖动，所以并不会很大的改善飞行表现。对于老旧的RC信号会抖动的遥控器来说，20或者40可能会对抖动现象有所改善。

以下是新的默认设置:

```
set rc_smoothing_type = FILTER
set rc_smoothing_input_hz = 0
set rc_smoothing_derivative_hz = 0
set rc_smoothing_input_type = BIQUAD
set rc_smoothing_derivative_type = PT1
set rc_smoothing_auto_smoothness = 10
```

### 动态Dterm滤波曲线指数

`dyn_lpf_dterm_curve_expo` 现在随着油门的增加，Dterm低通滤波器的截止频率会比以前更快地上升。Dterm低通滤波器截止频率会零油门时就开始随油门升高，将其设置得大于等于5可以改善对洗桨的抑制。

动态调整的范围, `dyn_lpf_dterm_min_hz` 和 `dyn_lpf_dterm_max_hz`, 仍然保持不变，现在只是会更快地到达最大值。

* 默认值（6）已经很好用了。
* 1是一个很平缓的曲线-几乎是线性的-在整个油门区间从最小到最大。
* 6是一个从零油到半油有迅速上升的曲线。

图表请参阅[PR9486](https://github.com/betaflight/betaflight/pull/9486).

### 动态电池压降补偿

该功能在满电时降低电机的输出量，然后在飞行过程中向上提升电机的输出，以在电池电压发生下降时进行快速补偿。

该功能在整个可用的电池电压区间中自动补偿动力，可提供一个更一致的飞行手感，从油门和PID来说都是如此。飞机在起飞时不会感觉“很暴力”，也不会在在快降落时变得“很迟钝”。

最好启用：

```
set vbat_sag_compensation = 100
set vbat_pid_gain = OFF
```

这意味着“100%补偿电池压降”

注意1：飞机必须有一个板载电池电压传感器。无法使用ESC遥测得电压，因为其值变化太慢。

注意2：一定不要同时启用`vbat_pid_gain`这个旧的电池电压补偿方式。

注意3：仅当您通过遥控器遥测或OSD对电池电压进行主动监控时才启用此功能。当电池电压下降至3.5V之后，您会立刻失去“跟手感”。

注意4：在3D模式下无法工作。

该代码可以从4.2V到3.5V（用户可自行配置）警告电压之间的电压变化进行动态补偿。

从4.2V到3.5V大约下降了16%的电压。在100%的补偿中，满电时，电机输出将被削减16%。当电压下降时，电机输出会逐渐升回正常状态，从而抵消电压骤降带来的动力损失。一旦电池电压低于3.5V，动力就将恢复正常，不再有更多的补偿。.

启用电池电压补偿之后，可能需要重新调整油门限制和电机输出限制。如果您的静态 `motor_output_limit` 值已经低于100，电池电压补偿会进一步降低电机输出。可能要把 `motor_output_limit` 上升10以获得相似的整体性能。通常不需要更改油门限制。

如果想在起飞时有更多的动力余量，以牺牲一定的“手感”为待见，那就可以将补偿设为较低的值。例如50%补偿`set vbat_sag_compensation = 50`。

将补偿值设置得超过100%可能会对压降极为严重得情况有所帮助，但通常来说并不需要。

有两种电池压降的情况：

* 随着电池电量消耗，电压在几分钟内缓慢下降
* 由于油门抖动期间的瞬态高电流负载而导致电压快速下降

若您只需要补偿电压缓慢下降的情况，请将`vbat_sag_lpf_period`设置为200（20秒为周期，或时间常数为3.3秒）。这样并不能够补偿电压的快速瞬间下降。较高的值对于慢速飞行或者电影式飞行有很大的帮助。

若需要补偿电压快速下降，择请坚持使用默认值（`vbat_sag_lpf_period`为2或200毫秒，时间常数大致为33毫秒）。它足够快，可以非常快速地响应油门瞬变和Split-S动作时带来的电压下降。

室内无刷/空心杯的飞行电压往往低于普通的2寸/3寸四轴，因此警告电压通常设置得更低，例如3.3V，衰减范围、电机输出最大抑制量都会更大一些。在这种情况下，稍微降低补偿量，例如80%，将去除它在起飞满电时过于“肉”的感觉。但是，有些小屋刷的电池压降幅度很大，而在某些情况下，高于100的补偿值可能有助于在整个电池范围内获得更一致的“感觉”。

若使用HV电池则无需调整。

将调试通道设置为`BATTERY`则可以在OSD或黑盒日志中显示补偿的额度。

调试通道2显示的是补偿力度，一个介于0和100之间的值。0表示您的电压处于补偿范围内的低端，并且无法进行进一步的补偿。100表示您的电池电量充沛，并且输出补偿已处于最大。如果您愿意的话，它可以被视作一个简单的0-100电池状态显示器。

调试通道3则显示的是电机输出降低的实际百分比。满电时默认值在160（16%）。如果补偿值为50%，则会在满电时看到仅有8%的补偿量。

### 全新的Rate模式

我们开发了两套全新的Rates模式，并升级了配置程序使之能以图表的方式显示所有的Rates设置。强烈建议使用最新版的配置程序。零expo，在中位附近灵敏度较低的Actual Rate推荐给摄影飞行或花式飞行。

这两个新Rate分别是`ACTUAL`和`QUICK`。

他们可以完全独立地对中位手感、指数曲线和最大滚转速率进行调整。

中位手感由中位附近的速率曲线决定。在新的模式中，可以直接设定中位手感，且其他参数并不会影响它。

`QUICK` 模式从之前的Betaflight中继承了传统的RCRate值用于设置中位手感。你可以保持旧的设置不变。

`ACTUAL` 模式可以让你用度/秒来设置最大滚转速率。将原来的RCRate值乘以200可换算为度/秒的数值。例如，1.0的RCRate会被换算成200的中位值。在 `ACTUAL` 模式中，中位和最大速率具有相同的单位，并且可以直接地通过在中位和其他位置的手感比较出来。

在新模式中，expo会增加曲线的曲率，但不会改变中位速率（Rate曲线在中位处的斜率）和最大滚转速率。较高的expo会使曲线更为弯曲，飞机不会快速旋转除非打满杆量。这比较受花飞飞手欢迎。较低的expo提供更大的低灵敏度范围和更可预测的飞机反应。这比较受喜爱高中位灵敏度的竞速飞手和喜爱低中位灵敏度的摄影飞手欢迎。

在 `ACTUAL` 模式中，expo的数值可以被降得比以前更低。这对于要求平滑飞行的摄影飞手是个好消息。

对花飞飞手来说，高expo值可提供大范围的线性手感，但在打满杆时，又可以有一个迅速的滚转。

在 `QUICK` 模式中，expo曲线会更为传统。不同的曲线可在地面站中可视化地调整。

最后，当增加死区时，最大滚转速率也不会变了。

这个在线计算器可以[将BF与Actual可视化](https://www.desmos.com/calculator/r5pkxlxhtb)，使换算旧的Rate值更为简便。这个计算器则用于 [Quick Rates](https://illusionfpv.github.io)

### 自动偏航溢流抑制

BF 4.2现在默认将 `yaw_spin_threshold` 设为比最大yaw轴滚转速率略小一点的值。在大多数情况下这会使yaw轴旋转抑制在撞击物品并旋转时更快地运作。而且现在飞手可以在竞速、花飞的Rate文件间自由切换， `yaw_spin_threshold` 会自动调整。

在CLI中使用 `yaw_spin_recovery`. 进行模式设置。设置项为 `OFF`, `ON`, 或 `AUTO`（默认）。如果要手动设置阈值，设为`ON` 并使用 `yaw_spin_threshold`设置数值。

我们希望`AUTO`适合所有人。更多信息请参阅[这里](https://github.com/betaflight/betaflight/pull/9455)。

### 反重力增益值从I值中独立

以前，反重力增益值是作为PID I值的一个倍数，意味着当I值增加了，反重力的强度也会增加，反之亦然。这可以导致I值过高时在油门迅速变动时的抖动，或者是I值较低时反重力效果不足。

4.2中，反重力增益从PID中独立出来，由反重力增益独立调整。

如果先前将I值调的高于默认，则需要调高反重力的增益值，反之亦然，以此获得与之前相当的反重力效果。对反重力增益的调整应该与I值相对于默认值的比例成比例。

### 升级了的动态陷波滤波器

我们对动态陷波滤波器做了大量的修改，它现在可以更精确、更大范围地识别和跟踪噪声。在大多数飞机上会有更好的效果。它会在非标准的陀螺仪刷新率下更精确。

相较于以前的设定范围如 `AUTO`, `LOW`, `MEDIUM` 或 `HIGH`, 现在用户可以直接设置他们想要的动态陷波滤波器覆盖的最大频率，用 `dyn_notch_max_hz`调整。动态陷波滤波器会帮助控制在设置频率范围内出现的噪声。

&#x20;`dyn_notch_max_hz` 的默认值600Hz适合大部分飞机。最佳数值取决于是否使用RPM滤波和飞机的转速范围。

如果以前使用 `LOW`, `dyn_notch_max_hz` ，350Hz左右应该够用了。如果以前使用 `HIGH`，大概700Hz就行。我几乎没见过转速比这还高的飞机。

未使用RPM滤波时，动态陷波滤波器需要覆盖整个可能的电机频率。需要的数值可通过开启 GYRO\_SCALED 调试模式并观察频谱图获取。或者可以用70%的峰值空载转速来估计。例如，2000kv的电机使用6S时空载转速约为2000\*6\*4=48000rpm，70%就是33600rpm，除以60就得到了560Hz。

响应迟缓的飞机如X-class应使用350-400Hz的 `dyn_notch_max_hz` 和比默认更低的 `dyn_notch_min_hz` 。较低的最大值会改善飞行表现。

开启RPM滤波时，电机噪声会几乎被完全消除，动态陷波滤波器就没什么可做的了，一般而言可以将其关闭。但是，它可以有效削减残留噪声或者机架的共振。如果机架没有共振，他就会停留在设定范围的中心，进而导致极少的延迟。

如果在某个频率有共振，可以将陷波器的最大、最小值设在这个固定频率的附近。例如，如果有150Hz的共振，试试把最小值设为100，最大值设为200。

无论将最大值设得多低，实际使用的值不会低于最小值的两倍。这用以保证程序正常运行。

4.1调参指南中的关于陷波器宽度和Q值的部分依然有效。总而言之，当使用RPM滤波时：4.1调参指南中的关于陷波器宽度和Q值的部分依然有效。总而言之，当使用RPM滤波时：

```
set dyn_notch_width_percent = 0
set dyn_notch_q = 250
```

不使用RPM滤波时：

```
set dyn_notch_width_percent = 8
set dyn_notch_q = 120
```

### I值释放可在设定点模式下正常工作

在4.0和4.1中有一个影响I值释放的设定点模式下的Bug。默认设置下设定点模式可以用，但调整 `iterm_relax_cutoff` 几乎是无效的。此Bug不影响陀螺仪模式下的I值释放。

这就是为什么只有在陀螺仪模式下降低 `iterm_relax_cutoff` 值才可有效减弱回弹。现在，设定点模式在所有 `iterm_relax_cutoff` 值下都可正常运作。

我们建议4.2的用户使用设定点模式。

调整 `iterm_relax_cutoff`时，为减小由I引起的回弹，调到最大值可提供充分的回弹抑制。

为确认飞机的回弹是由I引起的，而不是由于其他的什么东西，可以临时将 `iterm_relax_cutoff` 设到较高的值，如40，然后进行测试飞行。如果回弹反而加剧了，降低 `iterm_relax_cutoff` 的值直到它被完全抑制。

对大多数搭载GoPro的花飞机来说，10左右的 `iterm_relax_cutoff` 就够了。7寸大约是5-7.X-class是5或更低。

### NFE竞速模式

仅在自稳模式有效。

启用后，Roll轴是自稳，Pitch轴与手动模式无异。

使用以下CLI命令以启用该功能： `set level_race_mode = ON`.

### OSD升级



可以在每次解锁时显示自定义的logo了。\
CLI命令： `set osd_logo_on_arming = ON` 选项有 OFF, ON, FIRST\_ARMING.

CRSF的连接质量现在显示为“A:BB”。A是RF刷新率（2=150Hz，1=50Hz），BB是连接质量。该调整可使连接质量正常工作。

以下新元素被加入OSD：

* 相机取景框 (#9261)
* 飞行距离警报，使飞行距离闪烁。备注：距离的单位是米 (#8862)
* 电池效率。单位是mAh/km或mAh/mi (#9601)

### 配置程序的改进

Rate设置页面完全支持所有模式的rate曲线图像显示。

PD平衡滑块现在只改变D，而不是P。使感受D造成的变化变得更容易。

动态怠速值可在PID调校页面开启和调整。

当开启Dmin时，原先的D列被重新命名为Dmax，以更直观地展示其作用。

Yaw轴的P值改变同pitch和roll。默认值略高。
